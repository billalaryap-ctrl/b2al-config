<!DOCTYPE html>
<html>
<head>
<title>B2AL HWID Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0c0c0c;color:#eee;font-family:Arial}
.card{background:#141414;padding:16px;margin:10px;border-radius:12px}
.btn{padding:8px 12px;border-radius:8px;border:none;margin-right:6px}
.reset{background:#2ecc71}
.ban{background:#e74c3c}
.extend{background:#3498db}
</style>
</head>

<body>
<h2>B2AL HWID & License Panel</h2>
<p>Repo: b2al-config</p>

<div id="users">Loading...</div>

<script>
const repo = "billalaryap-ctrl/b2al-config";
const filePath = "config.lua";

async function loadConfig(){
  const res = await fetch(
    `https://raw.githubusercontent.com/${repo}/main/${filePath}`
  );
  return await res.text();
}

// PARSER FULL KOMPATIBEL DENGAN FORMAT KAMU
function parseUsers(lua){
  const users = [];

  const usersBlock = lua.match(/users%s*=%s*{([\\s\\S]*?)}/);
  if(!usersBlock) return users;

  const block = usersBlock[1];

  const rg = /{([\\s\\S]*?)}/g;
  let m;

  while((m = rg.exec(block)) !== null){

    const t = m[1];

    const val = key => {
      const r = t.match(new RegExp(key+`\\s*=\\s*"(.-)"`));
      return r ? r[1] : "";
    };

    const user = val("user");
    if(user === "") continue;

    users.push({
      user,
      expire: val("expire"),
      hwid: val("hwid"),
      banned: /ban\\s*=\\s*true/.test(t)
    });
  }

  return users;
}

function render(users){
  const box = document.getElementById("users");
  box.innerHTML = "";

  if(users.length === 0){
    box.innerHTML = "Tidak ada user ditemukan";
    return;
  }

  users.forEach(u=>{
    const d=document.createElement("div");
    d.className="card";

    d.innerHTML = `
      <b>User:</b> ${u.user}<br>
      <b>Expire:</b> ${u.expire}<br>
      <b>HWID:</b> ${u.hwid || "(kosong / siap daftar)"}<br>
      <b>Status:</b> ${u.banned ? "BANNED" : "ACTIVE"}<br><br>

      <button class="btn reset" onclick="resetHWID('${u.user}')">Reset HWID</button>
      <button class="btn ban" onclick="toggleBan('${u.user}')">${u.banned ? "Unban" : "Ban"}</button>
      <button class="btn extend" onclick="extendExpire('${u.user}')">Extend Expire</button>
    `;

    box.appendChild(d);
  });
}

async function commitEdit(modifier){
  const cfg = await loadConfig();
  const updated = modifier(cfg);

  await fetch(
    `https://api.github.com/repos/${repo}/contents/${filePath}`,
    {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        message:"panel update",
        content:btoa(unescape(encodeURIComponent(updated)))
      })
    }
  );

  alert("Berhasil diupdate â€” reload panel");
  location.reload();
}

async function resetHWID(name){
  commitEdit(cfg =>
    cfg.replace(
      new RegExp(`(user\\s*=\\s*"${name}"[\\s\\S]*?hwid\\s*=\\s*")([^"]*)`),
      `$1"`
    )
  );
}

async function toggleBan(name){
  commitEdit(cfg =>
    cfg.replace(
      new RegExp(`(user\\s*=\\s*"${name}"[\\s\\S]*?ban\\s*=\\s*)(true|false)?`),
      (m,p)=> p + (m.includes("true")?"false":"true")
    )
  );
}

async function extendExpire(name){
  const d = prompt("Masukkan tanggal baru (YYYY-MM-DD)");
  if(!d) return;

  commitEdit(cfg =>
    cfg.replace(
      new RegExp(`(user\\s*=\\s*"${name}"[\\s\\S]*?expire\\s*=\\s*")([^"]*)`),
      `$1${d}`
    )
  );
}

loadConfig().then(cfg => render(parseUsers(cfg)));
</script>
</body>
</html>
