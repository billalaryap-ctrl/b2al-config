<script>
const repo = "billalaryap-ctrl/b2al-config";
const filePath = "config.lua";

async function loadConfig(){
  const res = await fetch(
    `https://raw.githubusercontent.com/${repo}/main/${filePath}`
  );
  return await res.text();
}

// PARSER SUPPORT:
// • tanpa koma di akhir user block
// • komentar di dalam field
// • format return { ... }
function parseUsers(lua){
  const users = [];

  // ambil isi table users
  const blockMatch = lua.match(/users%s*=%s*{([\\s\\S]*?)}/);
  if(!blockMatch) return users;

  const body = blockMatch[1];

  // ambil setiap { ... } di dalam users
  const rg = /{([\\s\\S]*?)}/g;
  let m;

  while((m = rg.exec(body)) !== null){

    const t = m[1];

    const get = key => {
      const r = t.match(new RegExp(key+`\\s*=\\s*"(.-)"`));
      return r ? r[1] : "";
    };

    users.push({
      raw:t,
      user:get("user"),
      pass:get("pass"),
      key:get("key"),
      hwid:get("hwid"),
      expire:get("expire"),
      ban:/ban\\s*=\\s*true/.test(t)
    });
  }

  return users.filter(u => u.user !== "");
}

function render(users){
  const box = document.getElementById("users");
  box.innerHTML = "";

  if(users.length === 0){
    box.innerHTML = "Tidak ada user ditemukan";
    return;
  }

  users.forEach(u=>{
    const d=document.createElement("div");
    d.className="card";

    d.innerHTML = `
      <b>User:</b> ${u.user}<br>
      <b>Expire:</b> ${u.expire}<br>
      <b>HWID:</b> ${u.hwid || "(kosong / siap daftar)"}<br>
      <b>Status:</b> ${u.ban ? "BANNED" : "ACTIVE"}<br><br>

      <button class="btn reset" onclick="resetHWID('${u.user}')">Reset HWID</button>
      <button class="btn ban" onclick="toggleBan('${u.user}')">${u.ban ? "Unban" : "Ban"}</button>
      <button class="btn extend" onclick="extendExpire('${u.user}')">Extend Expire</button>
    `;

    box.appendChild(d);
  });
}

async function commitEdit(modifier){
  const cfg = await loadConfig();
  const updated = modifier(cfg);

  await fetch(
    `https://api.github.com/repos/${repo}/contents/${filePath}`,
    {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        message:"Panel update",
        content:btoa(unescape(encodeURIComponent(updated)))
      })
    }
  );

  alert("Berhasil diupdate — reload panel");
  location.reload();
}

async function resetHWID(name){
  commitEdit(cfg =>
    cfg.replace(
      new RegExp(`(user\\s*=\\s*"${name}"[\\s\\S]*?hwid\\s*=\\s*")([^"]*)`),
      `$1"`
    )
  );
}

async function toggleBan(name){
  commitEdit(cfg =>
    cfg.replace(
      new RegExp(`(user\\s*=\\s*"${name}"[\\s\\S]*?ban\\s*=\\s*)(true|false)?`),
      (m,p)=> p + (m.includes("true")?"false":"true")
    )
  );
}

async function extendExpire(name){
  const d = prompt("Masukkan tanggal baru (YYYY-MM-DD)");
  if(!d) return;

  commitEdit(cfg =>
    cfg.replace(
      new RegExp(`(user\\s*=\\s*"${name}"[\\s\\S]*?expire\\s*=\\s*")([^"]*)`),
      `$1${d}`
    )
  );
}

loadConfig().then(cfg => render(parseUsers(cfg)));
</script>
